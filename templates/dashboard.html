{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Professional Dashboard</title>
  <style>
    :root {
      --bg-color: #f4f6f8;
      --text-color: #333;
      --card-bg: #ffffff;
      --sidebar-bg: #1f2937;
      --link-color: #d1d5db;
      --hover-bg: #374151;
      --header-bg: linear-gradient(to right, #667eea, #764ba2);
    }

    [data-theme='dark'] {
      --bg-color: #0f172a;
      --text-color: #f8fafc;
      --card-bg: #1e293b;
      --sidebar-bg: #111827;
      --link-color: #9ca3af;
      --hover-bg: #1f2937;
      --header-bg: linear-gradient(to right, #1e3a8a, #4c1d95);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      height: 100vh;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .sidebar {
      width: 250px;
      background-color: var(--sidebar-bg);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 30px 20px;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar h2 {
      font-size: 22px;
      text-align: center;
      margin-bottom: 40px;
      color: #fbbf24;
    }

    .sidebar a {
      display: block;
      padding: 12px 18px;
      margin-bottom: 12px;
      color: var(--link-color);
      text-decoration: none;
      border-radius: 6px;
      font-size: 15px;
    }

    .sidebar a:hover {
      background-color: var(--hover-bg);
      color: white;
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background-color: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .logout-btn:hover {
      background-color: #dc2626;
    }

    .main {
      margin-left: 250px;
      padding: 0;
      flex-grow: 1;
      overflow-y: auto;
    }

    .dashboard-header {
      padding: 50px 40px;
      background: var(--header-bg);
      color: white;
    }

    .dashboard-header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .dashboard-header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .toggle-theme {
      position: absolute;
      top: 20px;
      right: 30px;
      padding: 8px 12px;
      background-color: transparent;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

  

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        width: 100%;
        height: auto;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        padding: 10px;
        bottom: 0;
        top: auto;
        z-index: 1000;
      }

      .sidebar h2 {
        display: none;
      }

      .main {
        margin-left: 0;
        margin-bottom: 70px;
      }

      .toggle-theme {
        top: 10px;
        right: 10px;
      }
    }

/* ----profile css--- */
  
#profile-section {
  width: 100%;
  padding: 40px;
}

#profile-section .card {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  width: 100%;          /* Full width */
  max-width: 100%;      /* Remove restriction */
  margin: auto;
  padding: 30px;
}

#profile-section h2 {
  margin-bottom: 25px;
  font-size: 24px;
  color: var(--text-color);
  text-align: left; /* looks cleaner for full-width */
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 10px;
}

/* Profile Display */
#profileDisplay p {
  margin: 15px 0;
  font-size: 16px;
  color: var(--text-color);
}

#profileDisplay b {
  color: #4f46e5; /* Indigo accent */
}

/* Input Fields */
#profileEdit {
  display: grid;
  grid-template-columns: 1fr 1fr;  /* two-column layout */
  gap: 20px;
}

#profileEdit label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: var(--text-color);
}

#profileEdit input {
  width: 100%;
  padding: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 15px;
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: border 0.2s;
}

#profileEdit input:focus {
  border-color: #6366f1;
  outline: none;
  box-shadow: 0 0 4px rgba(99, 102, 241, 0.4);
}

/* Buttons */
#profile-section .btn {
  display: inline-block;
  padding: 12px 20px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  margin-top: 15px;
  margin-right: 10px;
  transition: transform 0.2s, box-shadow 0.2s;
}

#profile-section .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
}

#profile-section .btn[style*="background-color:#ef4444"] {
  background: #ef4444;
}

#profile-section .btn[style*="background-color:#ef4444"]:hover {
  background: #dc2626;
}
/* ---qr cs--- */
#qrModal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 60%; height: 60%;
  background-color: rgba(0,0,0,0.5);
  z-index: 999;
  display: flex; 
  align-items: center; 
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

/* Modal Box */
#qrModal > div {
  padding: 20px;          /* less padding */
  border-radius: 8px;     /* smaller radius */
  max-width: 320px;       /* narrower modal */
  min-height: 120px;      /* shorter height */
}

/* Compact input fields inside QR Modal */
#qrModal .form-group input,
#qrModal .form-group select {
  padding: 6px 8px;       /* smaller height */
  font-size: 12px;        /* smaller text */
}

#qrModal h2 {
  font-size: 16px;        /* smaller heading */
  margin-bottom: 10px;
}

#qrModal button.btn {
  padding: 8px 14px;      /* smaller button */
  font-size: 13px;
}

#scanFormModal > div {
  padding: 8px;
  border-radius: 6px;
  width: 70%;
  max-width: 200px;       /* aur slim */
  min-height: auto;
  max-height: 130px;      /* aur kam height */
  overflow-y: auto;
  font-size: 12px;
}

/* Compact form layout */
#scanFormModal form {
  display: flex;
  flex-direction: column;
  gap: 6px;               /* kam gap */
}

#scanFormModal input {
  padding: 3px 5px;       /* aur chota */
  font-size: 11px;
  height: 22px;           /* fixed small height */
}

#scanFormModal button.btn {
  padding: 4px 8px;
  font-size: 11px;
  height: 26px;
}

/* Form Groups */
.form-group {
  margin: 10px 0;
  text-align: left;
}

.form-group label {
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
  color: #333;
  font-size: 13px; /* slightly smaller label */
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 4px 8px;   /* smaller height */
  border: 1px solid #ccc;
  border-radius: 4px; /* sharper corners */
  font-size: 13px;    /* smaller font */
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
  border-color: #4A90E2;
  box-shadow: 0px 0px 3px rgba(74,144,226,0.3);
  outline: none;
}


/* Time Display */
#formattedTime {
  color: #777;
  font-size: 13px;
  margin-top: 5px;
  display: block;
}

#timerDisplay {
  margin-top: 12px;
  font-weight: bold;
  font-size: 14px;
  color: #444;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Section Wrapper */
.section {
  display: none; /* controlled via JS */
  padding: 30px 50px;
  background: #f8fafc; /* light dashboard-like background */
}

/* Card */
.pcard {
  background: #ffffff;
  border-radius: 12px;
  padding: 15px 20px;       
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border: 1px solid #e5e9f0;
  max-width: 500px;
  transition: all 0.3s ease;
}


/* Card hover effect */
.pcard:hover {
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

/* Card Heading */
.pcard h2 {
  font-size: 1.4rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 18px;
  border-bottom: 1px solid #e5e9f0;
  padding-bottom: 10px;
}


/* Button */
.btn {
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 12px 26px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(37,99,235,0.3);
}

.btn:hover {
  background: #1d4ed8;
  box-shadow: 0 4px 10px rgba(29,78,216,0.4);
  transform: translateY(-1px);
}

/* ---session css-- */
.table-container {
    overflow-x: auto;
    margin-top: 20px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }
  
  th {
    background-color: #f3f4f6;
    font-weight: 600;
    color: #374151;
  }
  
  tr:hover {
    background-color: #f9fafb;
  }
  
/* Session Filter Controls */
.filter-controls {
  background: #f8fafc;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.filter-controls .form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.filter-controls label {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
}

.filter-controls select {
  padding: 6px 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
  min-width: 120px;
}

/* Session Statistics */
.session-stats {
  border-left: 4px solid #3b82f6;
}

.stat-item {
  padding: 8px 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
}

.btn-delete {
  background: #ef4444;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.btn-delete:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-view {
  background: #10b981;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.btn-view:hover {
  background: #059669;
  transform: translateY(-1px);
}

/* Status Badges */
.status-active {
  background: #10b981;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.status-expired {
  background: #6b7280;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

/* Subjects Section Styling */
#subjects-section .card {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  width: 100%;
  margin: auto;
  padding: 30px;
}

#subjects-section h2 {
  margin-bottom: 25px;
  font-size: 24px;
  color: var(--text-color);
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 10px;
}

#subjects-section .form-group {
  margin-bottom: 20px;
}

#subjects-section label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: var(--text-color);
}

#subjects-section input,
#subjects-section select {
  width: 100%;
  padding: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 15px;
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: border 0.2s;
}

#subjects-section input:focus,
#subjects-section select:focus {
  border-color: #6366f1;
  outline: none;
  box-shadow: 0 0 4px rgba(99, 102, 241, 0.4);
}

/* Student Filter Controls */
.filter-controls {
  background: #f8fafc;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.filter-controls .form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.filter-controls label {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
}

.filter-controls select {
  padding: 6px 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
  min-width: 120px;
}

/* Student Statistics */
.session-stats {
  border-left: 4px solid #3b82f6;
}

.stat-item {
  padding: 8px 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}
.sidebar a {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 18px;
  margin-bottom: 10px;
  color: var(--link-color, #d1d5db);
  text-decoration: none;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 500;
  transition: background-color 0.3s, color 0.3s;
}

.sidebar a i {
  font-size: 18px;
  width: 20px;
  text-align: center;
}

.sidebar a:hover {
  background-color: var(--hover-bg, #374151);
  color: white;
}

.sidebar a.active {
  background-color: var(--hover-bg, #374151);
  color: white;
}

/* ====== Home Section Styling ====== */

.welcome-card {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  text-align: center;
  margin-bottom: 25px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.welcome-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.welcome-card h2 {
  font-size: 1.8rem;
  margin-bottom: 10px;
  font-weight: 600;
}

.welcome-card p {
  font-size: 1rem;
  opacity: 0.9;
  line-height: 1.6;
}

/* ====== Quick Links Section ====== */

.quick-links {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  padding: 25px;
  text-align: center;
  transition: 0.3s ease;
}

.quick-links h3 {
  color: #333;
  font-weight: 600;
  margin-bottom: 20px;
}

.quick-links button {
  background: linear-gradient(to right, #667eea, #764ba2);
  border: none;
  color: #fff;
  font-size: 15px;
  font-weight: 500;
  padding: 12px 24px;
  margin: 10px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
}

.quick-links button i {
  margin-right: 8px;
}

.quick-links button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
  background: linear-gradient(to right, #5a67d8, #6b46c1);
}

/* ====== Responsive Design ====== */
@media (max-width: 768px) {
  .welcome-card h2 {
    font-size: 1.5rem;
  }

  .quick-links button {
    display: block;
    width: 100%;
    margin: 10px 0;
  }
}

  </style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
/>
</head>
<body data-theme="light">
   
  <!-- Sidebar -->
  <div class="sidebar">
    <div>
      <h2>Dashboard</h2>
      <a href="#" onclick="showSection('home-section')"><i class="fa-solid fa-house"></i>  Home</a>
      <a href="#" onclick="showSection('profile-section')"><i class="fa-solid fa-user"></i>  Profile</a>
      <a href="#" onclick="showSection('student-section')"><i class="fa-solid fa-people-roof"></i>  Manage Students</a>
      <a href="#" onclick="showSection('subjects-section')"><i class="fa-solid fa-book"></i>  Manage Subjects</a>
      <a href="#" onclick="showSection('qr-section')"><i class="fa-solid fa-qrcode"></i>  Create QR</a>
      <a href="#" onclick="showSection('sessions-section')"><i class="fa-solid fa-calendar-days"></i>  Sessions</a>
      <a href="#" onclick="showSection('report-section')"> <i class="fa-solid fa-file"></i>  Report</a>
    </div>
    <form action="/logout" method="get">
      <button class="logout-btn" type="submit">Logout</button>
    </form>
  </div>



  <!-- Main Content -->
  <div class="main">
    <!-- Background Header -->
 <div class="dashboard-header">
    <button class="toggle-theme" onclick="toggleTheme()" id="themeIcon">üåô</button>
    <h1>Welcome, <span id="dashboardName">{{ username }}</span>!</h1>
    <p>This is your personalized dashboard. You can manage your profile, view stats, and more.</p>
  </div>
  

<div class="section" id="home-section">
  <div class="welcome-card">
  <h2>Welcome to the QR Attendance Dashboard üéì</h2>
  <p>Manage your classes, subjects, and attendance efficiently. Generate secure QR codes, track attendance reports, and view all your teaching sessions ‚Äî all in one place.</p>
</div>
<div class="quick-links">
  <h3>Quick Actions</h3>
  <button onclick="showSection('qr-section')"><i class="fa-solid fa-qrcode"></i> Generate QR</button>
  <button onclick="showSection('student-section')"><i class="fa-solid fa-people-roof"></i> Manage Students</button>
  <button onclick="showSection('report-section')"><i class="fa-solid fa-file"></i> View Reports</button>
</div>
</div>
  <!-- Add this section for student management -->
<div class="section" id="student-section" style="display:none; padding:40px;">
  <div class="card">
    <h2>Manage Students</h2>
    
    <!-- Add Student Form -->
    <div style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
      <h3 style="margin-bottom: 15px;">Add New Student</h3>
      <div class="form-group">
        <label>Class:</label>
        <select id="studentClass">
          <option value="fy">FY</option>
          <option value="sy">SY</option>
          <option value="ty">TY</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Stream:</label>
        <input type="text" id="studentStream" placeholder="e.g., BBA, CA, etc.">
      </div>
      
      <div class="form-group">
        <label>Roll No:</label>
        <input type="text" id="studentRollNo" placeholder="Student Roll No">
      </div>
      
      <div class="form-group">
        <label>Name:</label>
        <input type="text" id="studentName" placeholder="Student Name">
      </div>
      
      <button class="btn" onclick="addStudent()">Add Student</button>
    </div>

    <!-- Filter Controls -->
    <!-- Update the student section filter controls -->
<div class="filter-controls" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
  <h3 style="margin-bottom: 15px;">Filter Students</h3>
  <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
    <div class="form-group" style="margin: 0;">
      <label>Class:</label>
      <!-- Changed ID to avoid conflict -->
      <select id="studentFilterClass" onchange="loadStudents()">
        <option value="all">All Classes</option>
        <option value="fy">FY</option>
        <option value="sy">SY</option>
        <option value="ty">TY</option>
      </select>
    </div>
    
    <div class="form-group" style="margin: 0;">
      <label>Stream:</label>
      <select id="filterStream" onchange="loadStudents()">
        <option value="all">All Streams</option>
        <!-- Stream options will be populated dynamically -->
      </select>
    </div>
    
    <div class="form-group" style="margin: 0;">
      <label>Sort By:</label>
      <select id="sortStudents" onchange="loadStudents()">
        <option value="rollno">Roll No</option>
        <option value="name">Name</option>
        <option value="class">Class</option>
        <option value="stream">Stream</option>
      </select>
    </div>
    
    <button class="btn" onclick="clearStudentFilters()" style="background-color: #6b7280; padding: 8px 16px;">
      Clear Filters
    </button>
    
    <button class="btn" onclick="downloadStudentList()" style="background-color: #10b981; padding: 8px 16px;">üì• Download List</button>
  </div>
</div>
    
    <!-- Student List -->
    <h3 style="margin-top: 30px;">Student List</h3>
    <div class="table-container">
      <table id="studentsTable">
        <thead>
          <tr>
            <th>Roll No</th>
            <th>Name</th>
            <th>Class</th>
            <th>Stream</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentsTableBody">
          <!-- Students will be populated here -->
        </tbody>
      </table>
    </div>
    
    <!-- Student Statistics -->
    <div class="session-stats" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
      <h4>Student Statistics</h4>
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="stat-item">
          <strong>Total Students:</strong> <span id="totalStudents">0</span>
        </div>
        <div class="stat-item">
          <strong>FY Students:</strong> <span id="fyStudents">0</span>
        </div>
        <div class="stat-item">
          <strong>SY Students:</strong> <span id="syStudents">0</span>
        </div>
        <div class="stat-item">
          <strong>TY Students:</strong> <span id="tyStudents">0</span>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Subjects Management Section -->
<div class="section" id="subjects-section" style="display:none; padding:40px;">
  <div class="card">
    <h2>Manage Subjects</h2>
    
    <div class="form-group">
      <label>Class Name:</label>
      <input type="text" id="subjectClass" placeholder="e.g., FYBBACA, SYBBACA, TYBBACA, FYBBA, etc.">
    </div>
    
    <div class="form-group">
      <label>Subject Name:</label>
      <input type="text" id="subjectName" placeholder="Enter subject name">
    </div>
    
    <button class="btn" onclick="addSubject()">Add Subject</button>
    
    <h3 style="margin-top: 30px;">Subjects List</h3>
    
    <div class="form-group">
      <label>Filter by Class:</label>
      <select id="filterSubjectClass" onchange="loadSubjects()">
        <option value="">All Classes</option>
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    
    <div class="table-container">
      <table id="subjectsTable">
        <thead>
          <tr>
            <th>Class Name</th>
            <th>Subject Name</th>
            <th>Added On</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="subjectsTableBody">
          <!-- Subjects will be populated here -->
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Update the report section -->
<!-- Update the report section -->
<div class="section" id="report-section" style="display:none; padding:40px;">
  <div class="card">
    <h2>Attendance Reports</h2>
    
    <!-- Report Generation Form -->
    <div style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
      <h3 style="margin-bottom: 15px;">Generate New Report</h3>
      
      <div class="form-group">
        <label>Class:</label>
        <select id="reportClass">
          <option value="FY">FY</option>
          <option value="SY">SY</option>
          <option value="TY">TY</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Stream:</label>
        <input type="text" id="reportStream" placeholder="e.g., BBA, CA, etc." oninput="updateReportSubjectOptions()">
      </div>
      
      <div class="form-group">
        <label>Subject:</label>
        <select id="reportSubject">
          <option value="">Select Class and Stream first</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Session Date:</label>
        <select id="reportSessionDate">
          <option value="">Select Subject first</option>
        </select>
      </div>
      
      <button class="btn" onclick="generateReport()">Generate Report</button>
      <button class="btn" style="background-color: #10b981;" onclick="downloadDefaultAbsentList()">
  üì• Download Absent List
</button>
    </div>

    <!-- Generated Reports -->
    <h3 style="margin-top: 30px;">Generated Reports</h3>
    
    <!-- Filter Controls -->
    <div class="filter-controls" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
      <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
        <div class="form-group" style="margin: 0;">
          <label>Sort By:</label>
          <select id="sortReports" onchange="loadReports()">
            <option value="date">Date</option>
            <option value="subject">Subject</option>
            <option value="class">Class</option>
          </select>
        </div>
        
        <div class="form-group" style="margin: 0;">
          <label>Filter by Class:</label>
          <select id="filterReportClass" onchange="loadReports()">
            <option value="all">All Classes</option>
            <option value="FY">FY</option>
            <option value="SY">SY</option>
            <option value="TY">TY</option>
          </select>
        </div>
        
        <button class="btn" onclick="clearReportFilters()" style="background-color: #6b7280; padding: 8px 16px;">
          Clear Filters
        </button>
      </div>
    </div>
    
    <div class="table-container">
      <table id="reportsTable">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Subject</th>
            <th>Class</th>
            <th>Session Date</th>
            <th>Generated On</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportsTableBody">
          <!-- Reports will be populated here -->
        </tbody>
      </table>
    </div>
  </div>
</div>
 <!-- Profile Section -->
<!-- Profile Section -->
<div class="section" id="profile-section" style="display:none; padding:40px;">
  <div class="card">
    <h2>Profile Information</h2>
    
    <!-- Display Profile -->
    <div id="profileDisplay">
      <p><b>Name:</b> <span id="displayName">{{ username }}</span></p>
      <p><b>Email:</b> <span id="displayEmail">Not set</span></p>
      <p><b>Role:</b> <span id="displayRole">Teacher</span></p>
      <p><b>Subject:</b> <span id="displaySubject">Not set</span></p>
      <button class="btn" onclick="editProfile()">‚úèÔ∏è Edit Profile</button>
    </div>

    <!-- Edit Profile Form -->
    <div id="profileEdit" style="display:none;">
      <div class="form-group">
        <label>Username:</label>
        <input type="text" id="editUsername" value="{{ username }}" style="width:100%; margin-bottom:10px;">
      </div>
      
      <div class="form-group">
        <label>Email:</label>
        <input type="email" id="editEmail" placeholder="Enter your email" style="width:100%; margin-bottom:10px;">
      </div>
      
      <div class="form-group">
        <label>Role:</label>
        <input type="text" id="editRole" value="Teacher" style="width:100%; margin-bottom:10px;">
      </div>
      
      <div class="form-group">
        <label>Subject:</label>
        <input type="text" id="editSubject" placeholder="Enter your subjects" style="width:100%; margin-bottom:10px;">
      </div>
      
      <button class="btn" onclick="saveProfile()">üíæ Save</button>
      <button class="btn" style="background-color:#ef4444;" onclick="cancelEdit()">‚ùå Cancel</button>
    </div>
  </div>
</div>
    <!-- Create QR Section -->
     

<div class="section" id="qr-section" style="display: none; padding: 40px;">
   <div class="pcard">
    <h2>Generate a QR Code</h2>
    <div class="form-group">
      <label></label>
      <select id="qrSubject">
        <!-- Subjects will be populated from profile -->
      </select>
    </div>
    <button class="btn" onclick="openModal()">Create QR</button>
  </div>
</div>
<!-- QR Modal -->
<!-- QR Modal -->
<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:10px; width:90%; max-width:400px; position:relative;">
    <button onclick="closeModal()" style="position:absolute; top:10px; right:15px; font-size:18px; background:none; border:none; cursor:pointer;">‚úñ</button>
    <h2>Create QR Code</h2>
    
    <!-- Class selection -->
    <div class="form-group">
      <label>Class</label>
      <select id="modalClass" onchange="updateQRSubjectOptions()">
        <option value="FY">FY</option>
        <option value="SY">SY</option>
        <option value="TY">TY</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Stream</label>
      <input type="text" id="modalStream" placeholder="e.g., BBA, CA, BBACA, etc." oninput="updateQRSubjectOptions()">
    </div>
    
    <div class="form-group">
      <label>Subject Name</label>
      <select id="modalSubject">
        <option value="">Select Class and Stream first</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="timeValue">Time Limit</label>
      <div style="display: flex; gap: 10px;">
        <input type="number" id="timeValue" placeholder="Enter time" style="flex: 2;">
        <select id="timeUnit" style="flex: 1;">
          <option value="seconds">Seconds</option>
          <option value="minutes">Minutes</option>
          <option value="hours">Hours</option>
        </select>
      </div>
      <small id="formattedTime" style="color: #666; margin-top: 4px; display: block;">üïí 00:00:00</small>
    </div>

    <div class="form-group">
      <label>Max Scans</label>
      <input type="number" id="maxScans" placeholder="">
    </div>
    
    <button class="btn" onclick="generateQR()">Generate QR</button>
    <canvas id="qrcode" style="margin-top: 20px;"></canvas>
    <div id="timerDisplay" style="margin-top:10px; font-weight:bold;"></div>
  </div>
</div>

<!-- Scan Form Popup -->
<div id="scanFormModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:300px; position:relative;">
    <button onclick="closeScanForm()" style="position:absolute; top:8px; right:12px; font-size:16px; background:none; border:none; cursor:pointer;">‚úñ</button>
    <h3>Enter Details</h3>
    <label>Name</label><input type="text" id="scanName" style="width:100%; margin-bottom:10px;">
    <label>Roll No</label><input type="text" id="scanRoll" style="width:100%; margin-bottom:10px;">
    <button class="btn" onclick="submitScan()">Submit</button>
  </div>
</div>
<!-- Sessions Section -->
<div class="section" id="sessions-section" style="display:none; padding:40px;">
  <div class="card">
    <h2>Your QR Sessions</h2><br>
    
    <!-- Sort and Filter Options -->
    <div class="filter-controls" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <div class="form-group" style="margin: 0;">
        <label>Sort By:</label>
        <select id="sortSessions" onchange="updateSessionsTable()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="subject">Subject</option>
          <option value="class">Class</option>
          <option value="time_limit">Time Limit</option>
        </select>
      </div>
      
      <div class="form-group" style="margin: 0;">
        <label>Filter by Class:</label>
        <select id="filterClass" onchange="updateSessionsTable()">
          <option value="all">All Classes</option>
          <option value="FY">FY</option>
          <option value="SY">SY</option>
          <option value="TY">TY</option>
        </select>
      </div>
      
      <div class="form-group" style="margin: 0;">
        <label>Filter by Status:</label>
        <select id="filterStatus" onchange="updateSessionsTable()">
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="expired">Expired</option>
        </select>
      </div>
      
      <button class="btn" onclick="clearFilters()" style="background-color: #6b7280; padding: 8px 16px;">
        Clear Filters
      </button>
    </div>
    
    <div class="table-container">
      <table id="sessionsTable">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Subject</th>
            <th>Class</th>
            <th>Time Limit</th>
            <th>Max Scans</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="sessionsTableBody">
          <!-- Sessions will be populated here -->
        </tbody>
      </table>
    </div>
    
    <!-- Session Statistics -->
    <div class="session-stats" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
      <h4>Session Statistics</h4>
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="stat-item">
          <strong>Total Sessions:</strong> <span id="totalSessions">0</span>
        </div>
        <div class="stat-item">
          <strong>Active Sessions:</strong> <span id="activeSessions">0</span>
        </div>
        <div class="stat-item">
          <strong>Expired Sessions:</strong> <span id="expiredSessions">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:400px;">
    <h3>Confirm Delete</h3>
    <p>Are you sure you want to delete this session? This action cannot be undone.</p>
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn" onclick="closeDeleteModal()" style="background-color: #6b7280;">Cancel</button>
      <button class="btn" onclick="confirmDelete()" style="background-color: #ef4444;">Delete</button>
    </div>
  </div>
</div>


  <!-- JS Scripts -->
    <script>
   function closeModal() {
    document.getElementById('qrModal').style.display = 'none';
    
    // Clear the QR code and timer
    clearQRCode();
    
    // Clear the form fields
    document.getElementById('modalClass').value = 'FY';
    document.getElementById('modalStream').value = '';
    document.getElementById('modalSubject').value = '';
    document.getElementById('timeValue').value = '';
    document.getElementById('timeUnit').value = 'seconds';
    document.getElementById('maxScans').value = '';
    document.getElementById('formattedTime').textContent = 'üïí 00:00:00';
}
  
// Profile functions - FIXED: User-specific data
function getUserId() {
    return "{{ session.get('user_id', '') }}"; // Flask session ‡§∏‡•á user_id ‡§≤‡•á‡§Ç
}

function getUserStorageKey() {
    return `profile_${getUserId()}`;
}

function editProfile() {
  document.getElementById("profileDisplay").style.display = "none";
  document.getElementById("profileEdit").style.display = "block";
  
  // Load current values into form - USER SPECIFIC
  const userStorageKey = getUserStorageKey();
  const savedProfile = JSON.parse(localStorage.getItem(userStorageKey)) || {};
  
  document.getElementById("editUsername").value = "{{ username }}";
  document.getElementById("editEmail").value = savedProfile.email || "";
  document.getElementById("editRole").value = savedProfile.role || "Teacher";
  document.getElementById("editSubject").value = savedProfile.subject || "";
}

function saveProfile() {
  const username = document.getElementById("editUsername").value;
  const email = document.getElementById("editEmail").value;
  const role = document.getElementById("editRole").value;
  const subject = document.getElementById("editSubject").value;

  if (!username.trim()) {
    alert("Username cannot be empty");
    return;
  }

  // Show loading
  const saveBtn = document.querySelector('#profileEdit .btn');
  const originalText = saveBtn.textContent;
  saveBtn.textContent = "Saving...";
  saveBtn.disabled = true;

  // Send update request to server
  fetch('/update-profile', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      username: username,
      email: email,
      role: role,
      subject: subject
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update display
      document.getElementById("displayName").textContent = username;
      document.getElementById("displayEmail").textContent = email || "Not set";
      document.getElementById("displayRole").textContent = role || "Teacher";
      document.getElementById("displaySubject").textContent = subject || "Not set";
      document.getElementById("dashboardName").textContent = username;

      // Save to localStorage - USER SPECIFIC KEY
      const userStorageKey = getUserStorageKey();
      localStorage.setItem(userStorageKey, JSON.stringify({ 
        username: username,
        email: email, 
        role: role, 
        subject: subject 
      }));

      alert('Profile updated successfully!');
      cancelEdit();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error updating profile');
  })
  .finally(() => {
    // Reset button
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  });
}


// Load subjects from profile
function loadSubjects() {
  const profile = JSON.parse(localStorage.getItem("profile"));
  if (profile && profile.subject) {
    const subjectSelect = document.getElementById('qrSubject');
    subjectSelect.innerHTML = '';
    
    // Split subjects by comma or other delimiters
    const subjects = profile.subject.split(/[,;]/).map(s => s.trim());
    
    subjects.forEach(subject => {
      if (subject) {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
      }
    });
  }
}


// Student management functions
let allStudents = [];

function addStudent() {
  const studentClass = document.getElementById('studentClass').value;
  const stream = document.getElementById('studentStream').value;
  const rollno = document.getElementById('studentRollNo').value;
  const name = document.getElementById('studentName').value;
  
  if (!studentClass || !stream || !rollno || !name) {
    alert("Please fill in all fields");
    return;
  }
  
  // Determine the full class name (e.g., FYBBA)
  const fullClassName = studentClass.toUpperCase() + stream.toUpperCase();
  
  fetch('/add-student', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      class: fullClassName,
      stream: stream,
      rollno: rollno,
      name: name
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Student added successfully');
      document.getElementById('studentRollNo').value = '';
      document.getElementById('studentName').value = '';
      loadStudents();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error adding student');
  });
}

// Update the loadStudents function to use the correct filter ID
function loadStudents() {
  const filterClass = document.getElementById('studentFilterClass').value;
  const filterStream = document.getElementById('filterStream').value;
  const sortBy = document.getElementById('sortStudents').value;
  
  // Load all students first
  Promise.all([
    fetch('/get-students/fy').then(r => r.json()),
    fetch('/get-students/sy').then(r => r.json()),
    fetch('/get-students/ty').then(r => r.json())
  ])
  .then(([fyData, syData, tyData]) => {
    allStudents = [];
    
    // Combine all students
    if (fyData.students) allStudents.push(...fyData.students.map(s => ({...s, classType: 'fy'})));
    if (syData.students) allStudents.push(...syData.students.map(s => ({...s, classType: 'sy'})));
    if (tyData.students) allStudents.push(...tyData.students.map(s => ({...s, classType: 'ty'})));
    
    // Apply filters
    let filteredStudents = allStudents.filter(student => {
      const classMatch = filterClass === 'all' || student.classType === filterClass;
      const streamMatch = filterStream === 'all' || student.stream.toLowerCase() === filterStream.toLowerCase();
      return classMatch && streamMatch;
    });
    
    // Apply sorting
    filteredStudents.sort((a, b) => {
      switch (sortBy) {
        case 'rollno':
          return a.rollno.localeCompare(b.rollno);
        case 'name':
          return a.name.localeCompare(b.name);
        case 'class':
          return a.class.localeCompare(b.class);
        case 'stream':
          return a.stream.localeCompare(b.stream);
        default:
          return a.rollno.localeCompare(b.rollno);
      }
    });
    
    displayStudents(filteredStudents);
    updateStudentStats();
    updateStreamFilterOptions();
  })
  .catch(error => {
    console.error('Error:', error);
    const tableBody = document.getElementById('studentsTableBody');
    tableBody.innerHTML = '<tr><td colspan="5">Error loading students</td></tr>';
  });
}

// Update clearStudentFilters to use the correct ID
function clearStudentFilters() {
  document.getElementById('studentFilterClass').value = 'all';
  document.getElementById('filterStream').value = 'all';
  document.getElementById('sortStudents').value = 'rollno';
  loadStudents();
}

function displayStudents(students) {
  const tableBody = document.getElementById('studentsTableBody');
  tableBody.innerHTML = '';
  
  if (students.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No students found</td></tr>';
    return;
  }
  
  students.forEach(student => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${student.rollno}</td>
      <td>${student.name}</td>
      <td>${student.class}</td>
      <td>${student.stream}</td>
      <td>
        <button class="btn" style="padding: 5px 10px; font-size: 12px; background-color: #ef4444;" onclick="deleteStudent('${student.classType}', '${student.rollno}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

function updateStudentStats() {
  const totalStudents = allStudents.length;
  const fyStudents = allStudents.filter(s => s.classType === 'fy').length;
  const syStudents = allStudents.filter(s => s.classType === 'sy').length;
  const tyStudents = allStudents.filter(s => s.classType === 'ty').length;
  
  document.getElementById('totalStudents').textContent = totalStudents;
  document.getElementById('fyStudents').textContent = fyStudents;
  document.getElementById('syStudents').textContent = syStudents;
  document.getElementById('tyStudents').textContent = tyStudents;
}

function updateStreamFilterOptions() {
  const streamSelect = document.getElementById('filterStream');
  const currentStreams = [...new Set(allStudents.map(student => student.stream))].sort();
  
  // Keep the "All Streams" option
  streamSelect.innerHTML = '<option value="all">All Streams</option>';
  
  currentStreams.forEach(stream => {
    if (stream) {
      const option = document.createElement('option');
      option.value = stream.toLowerCase();
      option.textContent = stream;
      streamSelect.appendChild(option);
    }
  });
}

function clearStudentFilters() {
  document.getElementById('filterClass').value = 'all';
  document.getElementById('filterStream').value = 'all';
  document.getElementById('sortStudents').value = 'rollno';
  loadStudents();
}

function deleteStudent(classType, rollno) {
  if (!confirm('Are you sure you want to delete this student?')) {
    return;
  }
  
  fetch(`/delete-student/${classType}/${rollno}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Student deleted successfully');
      loadStudents(); // Reload the student list
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting student');
  });
}

/// Report functions
// Report functions
function updateReportSubjectOptions() {
  const classType = document.getElementById('reportClass').value;
  const stream = document.getElementById('reportStream').value;
  
  if (classType && stream) {
    const fullClassName = classType + stream.toUpperCase();
    
    fetch(`/get-subjects/${fullClassName}`)
    .then(response => response.json())
    .then(data => {
      const subjectSelect = document.getElementById('reportSubject');
      subjectSelect.innerHTML = '<option value="">Select Subject</option>';
      
      if (data.subjects && data.subjects.length > 0) {
        data.subjects.forEach(subject => {
          const option = document.createElement('option');
          option.value = subject.subject_name;
          option.textContent = subject.subject_name;
          subjectSelect.appendChild(option);
        });
      } else {
        subjectSelect.innerHTML = '<option value="">No subjects found</option>';
      }
      
      // Clear session date options when subject changes
      document.getElementById('reportSessionDate').innerHTML = '<option value="">Select Subject first</option>';
    })
    .catch(error => {
      console.error('Error loading subjects:', error);
      const subjectSelect = document.getElementById('reportSubject');
      subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
    });
  }
}

function updateSessionDateOptions() {
  const subject = document.getElementById('reportSubject').value;
  const classType = document.getElementById('reportClass').value;
  const stream = document.getElementById('reportStream').value;
  
  if (subject && classType && stream) {
    const fullClassName = classType + stream.toUpperCase();
    
    fetch(`/get-session-dates?subject=${encodeURIComponent(subject)}&class_name=${encodeURIComponent(fullClassName)}`)
    .then(response => response.json())
    .then(data => {
      const dateSelect = document.getElementById('reportSessionDate');
      dateSelect.innerHTML = '<option value="">Select Session Date</option>';
      
      if (data.dates && data.dates.length > 0) {
        data.dates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = new Date(date).toLocaleDateString();
          dateSelect.appendChild(option);
        });
      } else {
        dateSelect.innerHTML = '<option value="">No sessions found</option>';
      }
    })
    .catch(error => {
      console.error('Error loading session dates:', error);
      document.getElementById('reportSessionDate').innerHTML = '<option value="">Error loading dates</option>';
    });
  }
}

function generateReport() {
  const classType = document.getElementById('reportClass').value;
  const stream = document.getElementById('reportStream').value;
  const subject = document.getElementById('reportSubject').value;
  const sessionDate = document.getElementById('reportSessionDate').value;
  
  if (!classType || !stream || !subject || !sessionDate) {
    alert("Please fill in all fields and select a session date");
    return;
  }
  
  // Determine the full class name (e.g., FYBBA)
  const fullClassName = classType + stream.toUpperCase();
  
  fetch('/generate-report', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subject: subject,
      class_name: fullClassName,
      session_date: sessionDate
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Report generated successfully');
      loadReports();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error generating report');
  });
}

function downloadDefaultAbsentList() {
  const classType = document.getElementById('reportClass').value;
  const stream = document.getElementById('reportStream').value;
  const subject = document.getElementById('reportSubject').value;
  const sessionDate = document.getElementById('reportSessionDate').value;
  
  if (!classType || !stream || !subject || !sessionDate) {
    alert("Please select class, stream, subject and session date first");
    return;
  }
  
  const fullClassName = classType + stream.toUpperCase();
  
  // Open download in new tab with ALL required parameters
  const url = `/download-default-absent-list/${fullClassName}?stream=${encodeURIComponent(stream)}&subject=${encodeURIComponent(subject)}&session_date=${encodeURIComponent(sessionDate)}`;
  window.open(url, '_blank');
}

function loadReports() {
  const sortBy = document.getElementById('sortReports').value;
  const filterClass = document.getElementById('filterReportClass').value;
  
  fetch('/get-reports')
  .then(response => response.json())
  .then(data => {
    const tableBody = document.getElementById('reportsTableBody');
    tableBody.innerHTML = '';
    
    if (data.error) {
      tableBody.innerHTML = `<tr><td colspan="6">${data.error}</td></tr>`;
      return;
    }
    
    // Apply filters
    let filteredReports = data.reports.filter(report => {
      const classMatch = filterClass === 'all' || 
                        (report.class_name && report.class_name.startsWith(filterClass));
      return classMatch;
    });
    
    // Apply sorting
    filteredReports.sort((a, b) => {
      if (sortBy === 'date') {
        return new Date(b.report_date) - new Date(a.report_date);
      } else if (sortBy === 'subject') {
        return a.subject.localeCompare(b.subject);
      } else if (sortBy === 'class') {
        return a.class_name.localeCompare(b.class_name);
      }
      return 0;
    });
    
    filteredReports.forEach(report => {
      // Extract session date from filename (format: report_subject_class_YYYYMMDD_random.xlsx)
      const filenameParts = report.filename.split('_');
      let sessionDate = report.report_date; // Default to report date
      
      // Try to extract date from filename (4th part after splitting by '_')
      if (filenameParts.length >= 4) {
        const datePart = filenameParts[3];
        if (datePart && datePart.length === 8) { // YYYYMMDD format
          const year = datePart.substring(0, 4);
          const month = datePart.substring(4, 6);
          const day = datePart.substring(6, 8);
          sessionDate = `${year}-${month}-${day}`;
        }
      }
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${report.filename}</td>
        <td>${report.subject}</td>
        <td>${report.class_name}</td>
        <td>${sessionDate}</td>
        <td>${report.created_at}</td>
        <td>
          <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="downloadReport('${report.filename}')">Download</button>
          <button class="btn" style="padding: 5px 10px; font-size: 12px; background-color: #ef4444;" onclick="deleteReport('${report.filename}')">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  })
  .catch(error => {
    console.error('Error:', error);
    const tableBody = document.getElementById('reportsTableBody');
    tableBody.innerHTML = '<tr><td colspan="6">Error loading reports</td></tr>';
  });
}

function clearReportFilters() {
  document.getElementById('sortReports').value = 'date';
  document.getElementById('filterReportClass').value = 'all';
  loadReports();
}

// Add event listeners
document.getElementById('reportClass').addEventListener('change', updateReportSubjectOptions);
document.getElementById('reportStream').addEventListener('input', updateReportSubjectOptions);
document.getElementById('reportSubject').addEventListener('change', updateSessionDateOptions);

function downloadReport(filename) {
  window.open(`/download-report/${filename}`, '_blank');
}

function deleteReport(filename) {
  if (!confirm('Are you sure you want to delete this report?')) {
    return;
  }
  
  fetch(`/delete-report/${filename}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Report deleted successfully');
      loadReports();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting report');
  });
} 


// Update the window.onload function
// Subjects management functions
function addSubject() {
  const className = document.getElementById('subjectClass').value.trim().toUpperCase();
  const subjectName = document.getElementById('subjectName').value.trim();
  
  if (!className || !subjectName) {
    alert("Please fill in both class name and subject name");
    return;
  }
  
  fetch('/add-subject', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      class_name: className,
      subject_name: subjectName
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Subject added successfully');
      document.getElementById('subjectName').value = '';
      loadSubjects();
      updateClassFilterOptions();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error adding subject');
  });
}

function loadSubjects() {
  const filterClass = document.getElementById('filterSubjectClass').value;
  
  if (filterClass) {
    // Load subjects for specific class
    fetch(`/get-subjects/${filterClass}`)
    .then(response => response.json())
    .then(data => {
      displaySubjects(data.subjects);
    })
    .catch(error => {
      console.error('Error:', error);
      const tableBody = document.getElementById('subjectsTableBody');
      tableBody.innerHTML = '<tr><td colspan="4">Error loading subjects</td></tr>';
    });
  } else {
    // Load all classes first, then show option to select
    updateClassFilterOptions();
    document.getElementById('subjectsTableBody').innerHTML = '<tr><td colspan="4">Select a class to view subjects</td></tr>';
  }
}

function displaySubjects(subjects) {
  const tableBody = document.getElementById('subjectsTableBody');
  tableBody.innerHTML = '';
  
  if (!subjects || subjects.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="4">No subjects found for this class</td></tr>';
    return;
  }
  
  subjects.forEach(subject => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${subject.class_name}</td>
      <td>${subject.subject_name}</td>
      <td>${subject.created_at}</td>
      <td>
        <button class="btn" style="padding: 5px 10px; font-size: 12px; background-color: #ef4444;" onclick="deleteSubject(${subject.id})">Delete</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}
function deleteSubject(subjectId) {
  if (!confirm('Are you sure you want to delete this subject?')) {
    return;
  }
  
  fetch(`/delete-subject/${subjectId}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Subject deleted successfully');
      loadSubjects(); // Reload the subjects list
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting subject');
  });
}
function updateClassFilterOptions() {
  fetch('/get-classes')
  .then(response => response.json())
  .then(data => {
    const filterSelect = document.getElementById('filterSubjectClass');
    filterSelect.innerHTML = '<option value="">All Classes</option>';
    
    if (data.classes && data.classes.length > 0) {
      data.classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        filterSelect.appendChild(option);
      });
    }
  })
  .catch(error => {
    console.error('Error loading classes:', error);
  });
}

// Update the QR generation to use stored subjects
function updateQRSubjectOptions() {
  const classType = document.getElementById('modalClass').value;
  const stream = document.getElementById('modalStream').value;
  
  if (classType && stream) {
    const fullClassName = classType + stream.toUpperCase();
    
    fetch(`/get-subjects/${fullClassName}`)
    .then(response => response.json())
    .then(data => {
      const subjectSelect = document.getElementById('modalSubject');
      subjectSelect.innerHTML = '<option value="">Select Subject</option>';
      
      if (data.subjects && data.subjects.length > 0) {
        data.subjects.forEach(subject => {
          const option = document.createElement('option');
          option.value = subject.subject_name;
          option.textContent = subject.subject_name;
          subjectSelect.appendChild(option);
        });
        
        // If only one subject exists, auto-select it
        if (data.subjects.length === 1) {
          subjectSelect.value = data.subjects[0].subject_name;
        }
      } else {
        // If no subjects found, show input field instead
        subjectSelect.innerHTML = '<option value="">No subjects found. Please add subjects first.</option>';
      }
    })
    .catch(error => {
      console.error('Error loading subjects:', error);
      const subjectSelect = document.getElementById('modalSubject');
      subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
    });
  }
}

// Initialize when page loads
window.onload = () => {
  // Set initial values from session
  const username = "{{ username }}";
  document.getElementById("dashboardName").textContent = username;
  document.getElementById("displayName").textContent = username;
  
  // Load saved profile from localStorage - USER SPECIFIC
  const userStorageKey = getUserStorageKey();
  const savedProfile = JSON.parse(localStorage.getItem(userStorageKey)) || {};
  
  if (savedProfile.email || savedProfile.role || savedProfile.subject) {
    document.getElementById("displayEmail").textContent = savedProfile.email || "Not set";
    document.getElementById("displayRole").textContent = savedProfile.role || "Teacher";
    document.getElementById("displaySubject").textContent = savedProfile.subject || "Not set";
  } else {
    // First time user - show empty/default values
    document.getElementById("displayEmail").textContent = "Not set";
    document.getElementById("displayRole").textContent = "Teacher";
    document.getElementById("displaySubject").textContent = "Not set";
  }
  
  updateSessionsTable();
  updateClassFilterOptions();
};

function cancelEdit() {
  document.getElementById("profileEdit").style.display = "none";
  document.getElementById("profileDisplay").style.display = "block";
}

function downloadStudentList() {
  const filterClass = document.getElementById('filterClass').value;
  const filterStream = document.getElementById('filterStream').value;
  
  let downloadClass = 'all';
  if (filterClass !== 'all') {
    downloadClass = filterClass;
  }
  
  // Open download in new tab
  window.open(`/download-student-list/${downloadClass}?stream=${filterStream}`, '_blank');
}

</script>

 <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  // Add this to your existing JavaScript
let qrSessions = JSON.parse(localStorage.getItem('qrSessions')) || [];

let currentSessions = [];
let sessionToDelete = null;

function updateSessionsTable() {
  const sortBy = document.getElementById('sortSessions').value;
  const filterClass = document.getElementById('filterClass').value;
  const filterStatus = document.getElementById('filterStatus').value;
  
  fetch('/get-sessions')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error:', data.error);
        return;
      }
      
      currentSessions = data.sessions;
      
      // Apply filters
      let filteredSessions = currentSessions.filter(session => {
        const classMatch = filterClass === 'all' || 
                          (session.class_name && session.class_name.startsWith(filterClass));
        const statusMatch = filterStatus === 'all' || 
                           session.status === filterStatus;
        return classMatch && statusMatch;
      });
      
      // Apply sorting
      filteredSessions.sort((a, b) => {
        const dateA = new Date(a.created_at);
        const dateB = new Date(b.created_at);
        
        switch (sortBy) {
          case 'newest':
            return dateB - dateA;
          case 'oldest':
            return dateA - dateB;
          case 'subject':
            return (a.subject || '').localeCompare(b.subject || '');
          case 'class':
            return (a.class_name || '').localeCompare(b.class_name || '');
          case 'time_limit':
            return (b.time_limit || 0) - (a.time_limit || 0);
          default:
            return dateB - dateA;
        }
      });
      
      displaySessions(filteredSessions);
      updateSessionStats(filteredSessions);
    })
    .catch(error => {
      console.error('Error:', error);
      const tableBody = document.getElementById('sessionsTableBody');
      tableBody.innerHTML = '<tr><td colspan="7">Error loading sessions</td></tr>';
    });
}

function displaySessions(sessions) {
  const tableBody = document.getElementById('sessionsTableBody');
  tableBody.innerHTML = '';
  
  if (sessions.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No sessions found</td></tr>';
    return;
  }
  
  sessions.forEach(session => {
    const row = document.createElement('tr');
    
    // Format time limit
    let formattedTimeLimit = '';
    if (session.time_limit < 60) {
      formattedTimeLimit = `${session.time_limit} sec`;
    } else if (session.time_limit < 3600) {
      formattedTimeLimit = `${Math.floor(session.time_limit/60)} min`;
    } else {
      formattedTimeLimit = `${Math.floor(session.time_limit/3600)} hour`;
    }
    
    // Format date
    const date = new Date(session.created_at);
    const formattedDate = date.toLocaleString();
    
    // Determine status
    const isExpired = session.status === 'expired' || 
                     (session.time_limit && 
                      (Date.now() - new Date(session.created_at).getTime()) > session.time_limit * 1000);
    const status = isExpired ? 'expired' : 'active';
    
    row.innerHTML = `
      <td>${formattedDate}</td>
      <td>${session.subject || 'N/A'}</td>
      <td>${session.class_name || 'N/A'}</td>
      <td>${formattedTimeLimit}</td>
      <td>${session.max_scans || 'N/A'}</td>
      <td><span class="status-${status}">${status.toUpperCase()}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-view" onclick="viewSession('${session.session_id}')">View</button>
          <button class="btn-delete" onclick="openDeleteModal('${session.session_id}')">Delete</button>
        </div>
      </td>
    `;
    
    tableBody.appendChild(row);
  });
}

function updateSessionStats(sessions) {
  const totalSessions = sessions.length;
  const activeSessions = sessions.filter(s => 
    s.status === 'active' || 
    !(s.time_limit && (Date.now() - new Date(s.created_at).getTime()) > s.time_limit * 1000)
  ).length;
  const expiredSessions = totalSessions - activeSessions;
  
  document.getElementById('totalSessions').textContent = totalSessions;
  document.getElementById('activeSessions').textContent = activeSessions;
  document.getElementById('expiredSessions').textContent = expiredSessions;
}

function clearFilters() {
  document.getElementById('sortSessions').value = 'newest';
  document.getElementById('filterClass').value = 'all';
  document.getElementById('filterStatus').value = 'all';
  updateSessionsTable();
}

function viewSession(sessionId) {
  const session = currentSessions.find(s => s.session_id === sessionId);
  if (session) {
    alert(`Session Details:\n\nSubject: ${session.subject}\nClass: ${session.class_name}\nTime Limit: ${session.time_limit} seconds\nMax Scans: ${session.max_scans}\nCreated: ${new Date(session.created_at).toLocaleString()}`);
  }
}

function openDeleteModal(sessionId) {
  sessionToDelete = sessionId;
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
  sessionToDelete = null;
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
  if (!sessionToDelete) {
    closeDeleteModal();
    return;
  }
  
  fetch(`/delete-session/${sessionToDelete}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Session deleted successfully');
      updateSessionsTable();
    } else {
      alert('Error: ' + data.error);
    }
    closeDeleteModal();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting session');
    closeDeleteModal();
  });
}
  function submitScan() {
    const name = document.getElementById('scanName').value;
    const roll = document.getElementById('scanRoll').value;
    
    if (!name || !roll) {
        alert("Please fill in all fields");
        return;
    }
    
    fetch('/submit-attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `name=${encodeURIComponent(name)}&roll_no=${encodeURIComponent(roll)}`
    })
    .then(response => {
        if (response.redirected) {
            if (response.url.includes('scan_limit_reached')) {
                alert("Scan limit reached for this QR code!");
            } else {
                window.location.href = response.url;
            }
        }
        return response.text();
    })
    .catch(error => {
        console.error('Error:', error);
    });
    
    closeScanForm();
}
  let countdownInterval;

  function openModal() {
  // Clear previous selections
  document.getElementById('modalClass').value = 'FY';
  document.getElementById('modalStream').value = '';
  document.getElementById('modalSubject').innerHTML = '<option value="">Select Class and Stream first</option>';
  document.getElementById('timeValue').value = '';
  document.getElementById('maxScans').value = '';
  document.getElementById('formattedTime').textContent = 'üïí 00:00:00';
  
  document.getElementById('qrModal').style.display = 'flex';
}


  function toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute("data-theme");
    const newTheme = currentTheme === "light" ? "dark" : "light";
    body.setAttribute("data-theme", newTheme);
    document.getElementById("themeIcon").textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
  }

  function showSection(sectionId) {
  const sections = document.querySelectorAll('.section');
  sections.forEach(s => s.style.display = 'none');
  document.getElementById(sectionId).style.display = 'grid';
  
  if (sectionId === 'sessions-section') {
    updateSessionsTable();
  }
}

function saveSession(subject, timeLimit, maxScans, className) {
  return fetch('/save-session', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subject: subject,
      timeLimit: timeLimit,
      maxScans: maxScans,
      class_name: className
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      return data;
    } else {
      throw new Error(data.error || 'Failed to save session');
    }
  });
}

  function generateQR() {
  // Check if QRCode library is available
  if (typeof QRCode === 'undefined') {
    alert("QR Code library failed to load. Please refresh the page.");
    console.error("QRCode library not loaded");
    return;
  }

  const classType = document.getElementById('modalClass').value;
  const stream = document.getElementById('modalStream').value;
  const subject = document.getElementById('modalSubject').value;
  const value = parseInt(document.getElementById('timeValue').value);
  const unit = document.getElementById('timeUnit').value;
  const maxScans = document.getElementById('maxScans').value;

  if (!classType || !stream || !subject || !value || !maxScans) {
    alert("Please fill in all fields");
    return;
  }

  // Rest of your function remains the same...
  const fullClassName = classType + stream.toUpperCase();
  
  let timeLimit = 0;
  if (unit === "seconds") timeLimit = value;
  else if (unit === "minutes") timeLimit = value * 60;
  else if (unit === "hours") timeLimit = value * 3600;

  // Save the session to the backend with class name
  saveSession(subject, timeLimit, maxScans, fullClassName)
    .then(sessionData => {
      if (sessionData.success) {
        // Use localhost for development instead of IP
        const qrData = `http://YOUR_IP_ADDRESS:5000/attendance-form?subject=${encodeURIComponent(subject)}&maxScans=${maxScans}&timeLimit=${timeLimit}&class_name=${encodeURIComponent(fullClassName)}&session_id=${sessionData.session_id}`;

        const canvas = document.getElementById('qrcode');
        
        // Clear any existing QR code first
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Generate new QR code with error handling
        try {
          QRCode.toCanvas(canvas, qrData, { width: 200 }, function (error) {
            if (error) {
              console.error(error);
              alert("Error generating QR Code: " + error.message);
            } else {
              console.log("QR Code generated successfully");
              startTimer(timeLimit);
            }
          });
        } catch (e) {
          console.error("QRCode.toCanvas error:", e);
          alert("Error generating QR Code. Please try again.");
        }
      } else {
        alert('Error saving session: ' + sessionData.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error saving session: ' + error.message);
    });
}


  function updateFormattedTime() {
    const value = parseInt(document.getElementById('timeValue').value) || 0;
    const unit = document.getElementById('timeUnit').value;

    let totalSeconds = 0;
    if (unit === "seconds") totalSeconds = value;
    else if (unit === "minutes") totalSeconds = value * 60;
    else if (unit === "hours") totalSeconds = value * 3600;

    const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const secs = String(totalSeconds % 60).padStart(2, '0');

    document.getElementById('formattedTime').innerText = `üïí ${hrs}:${mins}:${secs}`;
  }

  document.getElementById('timeValue').addEventListener('input', updateFormattedTime);
  document.getElementById('timeUnit').addEventListener('change', updateFormattedTime);

  function startTimer(duration) {
    const timerDisplay = document.getElementById("timerDisplay");
    let remaining = duration;

    function formatTime(sec) {
      const hrs = String(Math.floor(sec / 3600)).padStart(2, '0');
      const mins = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const secs = String(sec % 60).padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }

    timerDisplay.textContent = `QR valid for: ${formatTime(remaining)}`;
    clearInterval(countdownInterval);

    countdownInterval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        clearQRCode();
        timerDisplay.textContent = "QR expired.";
      } else {
        timerDisplay.textContent = `QR valid for: ${formatTime(remaining)}`;
      }
    }, 1000);
  }

  function clearQRCode() {
    const canvas = document.getElementById('qrcode');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Clear the timer display
    document.getElementById("timerDisplay").textContent = '';
    
    // Stop any running countdown
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
}





// Add event listeners for class and stream changes
document.getElementById('modalClass').addEventListener('change', updateQRSubjectOptions);
document.getElementById('modalStream').addEventListener('input', updateQRSubjectOptions);


  document.addEventListener("DOMContentLoaded", function() {
    // Show Home section automatically on dashboard load
    showSection('home-section');
  });

</script>

</body>
</html>